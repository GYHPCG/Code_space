### 五.Bcrypt加密

#### 一.概念：

Bcrypt是单向Hash加密算法，不可反向破解生成明文。bcrypt是由Niels Provos和David Mazières设计的密码哈希函数，它是==基于Blowfish密码==而来的，除了==加盐(salt)==来抵御彩虹表(rainbow table) 攻击之外，bcrypt的一个非常重要的特征就是==自适应性==，可以保证加密的速度在一个特定的范围内，即使计算机的运算能力非常高，可以通过增加迭代次数的方式，使得加密速度变慢，从而可以抵御暴力搜索攻击。

#### 二.加密流程：

由于**bcrypt**加密算法是基于**blowfish**加密算法。所以要说明bcrypt加密算法流程之前，我们先要了解一下**blowfish**加密算法的流程。在bcrypt的初始密钥设置中，salt 和 password 都被用来设置子密钥。然后经过一轮轮的标准Blowfish算法，通过交替使用salt 和 password作为key，每一轮都依赖上一轮子密钥的状态。相对于blowfish加密算法，在bcrypt加密中重置key的轮数是可以配置的，所以可以通过增加轮数来抵御暴力攻击。

##### 一. Blowfish加密：

1. **简介**：**BlowFish** 是一个对称加密的加密算法。每次加密数据为 **64位** （2个int)类型数据大小。八个字节。密钥采用==32-448==位，由一个16轮循环的Feistel结构进行加密的。大致流程看如下图所示：

   <img src="C:\Users\86183\AppData\Roaming\Typora\typora-user-images\image-20221223204743586.png" alt="image-20221223204743586" style="zoom:150%;" />

   先将原始的**64bit**的数据P分成左右两份L，R。然后先用左边的==L和Kr进行异或运算==，所得的结果再调用==F()函数==进行运算得到的结果再与右边的==R==进行异或操作，然后调换左右部分的位置，继续进行这样的操作，总共进行16轮就得到了最终的加密结果。

2. **计算关键变量Kr和函数F()**:        

   1. **密钥数组**：由上图易得，Kr 的范围是从**K1 到 K18** 。总共有18个密钥组成的数组。 每个密钥的长度是32位。密钥数组的初始化常用随机数。而获取一个足够随机的32bit的数，通常用==常数Π==的小数位，并将其转换为16进制来表示。如下

      ```c++
      // K1 = 0x76a301d3
      
      // K2 = 0xbc452aef
      
      // …
      
      // K18 = 0xd7acc4a5
      ```

      而blowfish的密钥长度是可变的，**32bits到448bits**，也就是1到14个32位的数字。我们可以用==Pi==来，那么则得到了14个可变长度的密钥。然后我们使用==K1和P1==进行异或操作，K2和P2进行异或操作，一直到K14和P14。因为P只有14个值，而K有18个值，所以接下来我们需要重复使用P的值，也就是==K15和P1==进行异或，K16和P2进行异或，直到K18和P4。

      将异或之后的值作为新的K数组的值。现在我们获得了一个新的K数组。

      **注意**：此时获取的K数组还不是最终的K数组。

   2. **S-BOX**:  S-box可以是固定的，也可以是动态的。比如，在DES中S-box就是静态的，而在Blowfish中S-box就是动态生成的。由上图可知，blowfish加密的==**F()函数**==需要四个S-BOX，函数的输入是32bits，首先将32bits分成4份，也就是4个8bits。S-box的作用就是将每8bits转换成为32bits，至于如何转换，可参考==DES加密算法的扩展过程==。其中四个S-BOX是固定的。其中F()函数的操作如下：

      ```c++
      1.先将S-Box0 和 S-BOx1的结果相加 % 2^32 得新的结果
      2.将新的结果与 S-BOX2的结果进行异或操作得新结果
      3.将新结果与S-BOX3的结果进行相加，最后得到32bits的结果，其中S-box的初始值也可以跟K数组一样，使用常量π的小数部分来初始化。
      ```

   3. **生成最终的K数组**：

      首先我们取一个全为0的64bits，然后K数组和S-box，应用blowfish算法，生成一个64bits。将这个64bits分成两部分，分别作为新的K1 和 K2。然后将这个64bits作为输入，再次调用blowfish算法，作为新的K3 和 K4。依次类推，最终生成所有K数组中的元素。4个S-box的数组也按照上面的流程来进行生成。从而得到最终的S-box。

##### 二.bcrypt hash结构

![image-20221223225527310](C:\Users\86183\AppData\Roaming\Typora\typora-user-images\image-20221223225527310.png)

其中密文结构为：**$**为分割符，**2y**是bcrypt加密版本号，10是代价因子cost的值，这里是2的10次方，也就是1024轮。紧随其后的22位是**salt**盐值（用来混淆密码使用），最后的字符串就是加密的密文。

##### 三.Bcrypt加密

1. 简单来说，可以理解bcrypt加密就是对字符串进行**64次blowfish**加密得到的结果。在bcrypt的初始密钥设置中，**盐值salt**（用来混淆密码使用） 和 password（就是我们要加密的密码） 都被用来设置子密钥。然后经过一轮轮的标准Blowfish算法，通过交替使用salt 和 password作为key，每一轮都依赖上一轮子密钥的状态。
2. 加密流程：
   1. 在输入部分，cost 表示的是轮循的次数，这个我们可以自己指定，轮循次数多加密就慢。salt 是加密用盐，用来混淆密码使用。password 就是我们要加密的密码了。最后的输出是加密后的结果hash。有了3个输入，我们会调用EksBlowfishSetup函数（）去初始化**18个subkeys和4个1K大小的S-boxe**s，从而达到最终的P和S。然后使用P和S对字符串进行**64次blowfish**运算，最终得到结果。
   2. EksBlowfishSetup 函数接收上面我们的**3个参数**，返回最终的包含18个子key的P和4个1k大小的S-BOX。首先初始化，得到最初的P和S。然后调用ExpandKey函数（主要用来生成P和S），传入salt和password，生成第一轮的P和S。然后循环2的cost方次，轮流使用password和salt作为参数去生成P和S，最后返回。即加密完成。